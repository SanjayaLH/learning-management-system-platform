@startuml student-views-courseList-then-details
skinparam style strictuml
skinparam SequenceMessageAlignment center

Title Student Views Course List then Details

actor "Client (Student on REST client)" as Client
box "Gateway Layer"
    participant "API Gateway" as ApiGateway
end box
box "Microservices Layer"
    participant "Authentication Service" as AuthService
    participant "Course Service" as CourseService
    participant "Enrollment Service" as EnrollmentService
end box
database "Course Database" as CourseDB

autonumber

group 1. Fetch List of ALL Available Courses
    Client -> ApiGateway: GET /courses/public + JWT
    note right of Client: Request to load course catalog

    activate ApiGateway
    ApiGateway -> AuthService: Validate Token (JWT)
    activate AuthService
    AuthService -> ApiGateway: Token Valid (User ID, Role: STUDENT)
    deactivate AuthService

    ApiGateway -> CourseService: Get Public Course List Request (User ID)
    deactivate ApiGateway
    activate CourseService
    
    CourseService -> CourseDB: Query: SELECT ID, Title, Teacher_ID, Description_Short FROM Course WHERE Is_Published = TRUE
    activate CourseDB
    CourseDB --> CourseService: List of Public Course Summaries
    deactivate CourseDB

    CourseService --> ApiGateway: 200 OK (List<CourseSummaryDTO>)
    deactivate CourseService
    activate ApiGateway
    ApiGateway --> Client: 200 OK (List of Courses)
    deactivate ApiGateway
end

== Student Clicks a Course they are Enrolled In ==

group 2. Fetch Single Course Details (Requires Enrollment Check)
    Client -> ApiGateway: GET /courses/{courseId} + JWT
    note right of Client: Request for full content/details

    activate ApiGateway
    ApiGateway -> AuthService: Validate Token (JWT)
    activate AuthService
    AuthService -> ApiGateway: Token Valid (User ID, Role: STUDENT)
    deactivate AuthService

    ApiGateway -> EnrollmentService: Check Enrollment (User ID, Course ID)
    activate EnrollmentService
    EnrollmentService -> EnrollmentService: Query Enrollment DB
    alt Is Enrolled
        EnrollmentService --> ApiGateway: Enrollment Confirmed (200 OK)
    else Not Enrolled
        EnrollmentService --> ApiGateway: Enrollment Rejected (403 Forbidden)
        deactivate EnrollmentService
        ApiGateway -[#red]-> Client: 403 Forbidden (Not Enrolled)
        deactivate ApiGateway
    end
    
    ApiGateway -> CourseService: Get Course Details Request (Course ID)
    deactivate EnrollmentService
    deactivate ApiGateway
    activate CourseService
    
    CourseService -> CourseDB: Query: SELECT * FROM Course WHERE ID = {courseId}
    activate CourseDB
    CourseDB --> CourseService: Full Course Record (Details)
    deactivate CourseDB

    CourseService --> ApiGateway: 200 OK (CourseDetailDTO)
    deactivate CourseService
    activate ApiGateway
    ApiGateway --> Client: Final Response (200 OK)
    deactivate ApiGateway
end
@endumll